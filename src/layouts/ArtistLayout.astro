---
import first from "lodash/first";
import last from "lodash/last";
import sortBy from "lodash/sortBy";

import Layout from "./Layout.astro";
import Spotify from "../components/Spotify.astro";
import ArtistNavigationLinks from "../components/ArtistNavigationLinks.astro";
import YouTube from "../components/YouTube.astro";
import { formatHumanDateTime } from "../utils/date";
import IconAndLabel from "../components/IconAndLabel.astro";
import ImageAndLabel from "../components/ImageAndLabel.astro";
import BuyTicketsButton from "../components/BuyTicketsButton.astro";

const {
  frontmatter: {
    spotifyUrl,
    youtubeUrl,
    title,
    author,
    authorImage,
    tagline,
    id,
    concertStartAt,
    venue,
    sponsoredByBergesenstiftelsen,
  },
} = Astro.props;

const artistsPages = await Astro.glob("../pages/artist/*.mdx");
const sortedArtistsPages = sortBy(
  [...artistsPages.filter(({ frontmatter: { hidden } }) => !hidden)],
  "frontmatter.concertStartAt"
);
const indexOfThisArtist = sortedArtistsPages.findIndex(
  ({ frontmatter: { id } }) => id === Astro.props.frontmatter.id
);
const previousArtist =
  indexOfThisArtist === 0
    ? last(sortedArtistsPages)
    : sortedArtistsPages[indexOfThisArtist - 1];
const nextArtist =
  indexOfThisArtist === sortedArtistsPages.length - 1
    ? first(sortedArtistsPages)
    : sortedArtistsPages[indexOfThisArtist + 1];

const randomHandSrc = `/profil/hand0${Math.floor(
  Math.random() * (6 - 1) + 1
)}.png`;
---

<Layout
  title={`${title} // mandaljazz 2023`}
  description={`${title} på mandaljazz! ${tagline}`}
  image={`/artist/${id}.png`}
>
  <main class="px-4 sm:px-6 md:px-8 lg:px-16 xl:px-32 py-20 sm:py-24">
    <div class="max-w-5xl mx-auto space-y-24">
      <div class="space-y-4">
        <div class="space-y-4">
          <h1 class="text-5xl md:text-7xl font-display">
            {title}
          </h1>
          <div class="grid grid-cols-5 flex-nowrap w-full items-end">
            <div class="col-span-3 space-y-8">
              <p class="text-3xl hyphens-auto">
                {tagline}
              </p>
              <div class="space-y-2">
                <IconAndLabel icon="time-outline">
                  {formatHumanDateTime(concertStartAt)}
                </IconAndLabel>
                <IconAndLabel icon="location-outline">{venue}</IconAndLabel>
              </div>
              {
                previousArtist && nextArtist ? (
                  <ArtistNavigationLinks
                    previousArtist={previousArtist}
                    nextArtist={nextArtist}
                    class="hidden lg:flex"
                  />
                ) : null
              }
            </div>
            <div class="col-span-2 relative">
              <img
                src={randomHandSrc}
                class="w-32 h-32 md:w-40 md:h-40 lg:w-48 lg:h-48 place-end rotate-2 translate-y-8"
                alt="Fargerik hånd som peker på tittelen ovenfor"
              />
            </div>
          </div>
        </div>

        <div class="relative">
          <div
            class="bg-no-repeat bg-cover bg-center w-full h-[520px] rounded"
            style={`background-image: url('/artist/${id}.png');`}
          >
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-y-4 lg:gap-x-4">
        <div class="col-span-2 space-y-4">
          <ImageAndLabel
            image={`/author/${authorImage}`}
            alt={`Bilde av ${author}`}
          >
            Tekst: {author}
          </ImageAndLabel>
          <article class="prose">
            <slot />
          </article>
        </div>
        <div class="col-span-1 flex flex-col gap-y-8">
          {
            spotifyUrl && (
              <div class="flex-1">
                <Spotify src={spotifyUrl} iframeClass="lg:h-full" />
              </div>
            )
          }
          <div class="flex flex-row justify-between">
            <BuyTicketsButton class="flex-0 w-fit h-fit" />
            {
              sponsoredByBergesenstiftelsen && (
                <div class="flex flex-col lg:items-end gap-y-1">
                  <p class="text-xs lg:text-right">
                    Konserten er støttet av{" "}
                    <span class="hidden">Bergesenstiftelsen</span>
                  </p>
                  <a
                    href={"https://bergesenstiftelsen.no/"}
                    title={"Bergesenstiftelsen"}
                    rel="noopener nofollow"
                    target="_blank"
                    class="block hover:-rotate-2 transition-transform"
                  >
                    <div
                      style={`background-image: url(/sponsor/bergesenstiftelsen.png);`}
                      class={`w-32 h-12 bg-no-repeat bg-contain bg-left`}
                    />
                  </a>
                </div>
              )
            }
          </div>
        </div>
      </div>
      {youtubeUrl && <YouTube src={youtubeUrl} />}
      {
        previousArtist && nextArtist ? (
          <ArtistNavigationLinks
            previousArtist={previousArtist}
            nextArtist={nextArtist}
          />
        ) : null
      }
    </div>
  </main>
</Layout>
