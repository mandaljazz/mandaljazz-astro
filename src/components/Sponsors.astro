---
import { getEntry } from "astro:content";
import { imagePathToSrc } from "../utils/images";
import SponsorList from "./SponsorList.astro";

type SponsorGroup =
  | "Generalsponsor"
  | "Hovedsponsorer"
  | "Sponsorer"
  | "Støttespillere"
  | "Offentlig støtte"
  | "Samarbeidspartnere";

type Sponsor = {
  name: string;
  url: string;
  image: ImageMetadata;
};

// Fetch sponsors from JSON data collection
const sponsors = await getEntry("sponsors", "sponsors");
const sponsorsWithImages = await Promise.all(
  sponsors.data.sponsors.map(async ({ name, image, ...rest }) => {
    try {
      const imageModule = await imagePathToSrc(image);
      const imageData = imageModule.default;
      return { name, image: imageData, ...rest };
    } catch (error) {
      console.warn(`Image not found for ${name}: ${image}`);
      return { name, image: null, ...rest };
    }
  }),
);

// Group sponsors by their group field
const sponsorsByGroup = sponsorsWithImages.reduce(
  (acc, sponsor) => {
    const group = sponsor.group;
    if (!acc[group]) {
      acc[group] = [];
    }
    acc[group].push({
      name: sponsor.name,
      url: sponsor.url,
      image: sponsor.image,
    });
    return acc;
  },
  {} as Record<SponsorGroup, Sponsor[]>,
);

// Get sponsors for each group
const generalSponsors: Sponsor[] = sponsorsByGroup["Generalsponsor"] || [];
const mainSponsors: Sponsor[] = sponsorsByGroup["Hovedsponsorer"] || [];
const regularSponsors: Sponsor[] = sponsorsByGroup["Sponsorer"] || [];
const supporterSponsors: Sponsor[] = sponsorsByGroup["Støttespillere"] || [];
const publicSponsors: Sponsor[] = sponsorsByGroup["Offentlig støtte"] || [];
const partners: Sponsor[] = sponsorsByGroup["Samarbeidspartnere"] || [];
---

<section class="bg-red/10 py-24 shadow-inner">
  <div class="px-4 sm:px-6 md:px-8 lg:px-16 xl:px-32">
    <div class="mx-auto flex max-w-5xl flex-col gap-12">
      <div class="space-y-8">
        <h1 class="text-md mx-auto w-fit px-4 py-2">Generalsponsor</h1>
        <SponsorList size="xl" sponsors={generalSponsors} />
      </div>
      <div class="grid gap-24 sm:grid-cols-5 sm:gap-8">
        <div class="space-y-8 sm:col-span-3">
          <h1 class="text-md mx-auto w-fit px-4 py-2">Hovedsponsorer</h1>
          <SponsorList size="lg" sponsors={mainSponsors} />
        </div>
        <div class="space-y-8 sm:col-span-2">
          <h1 class="text-md mx-auto w-fit px-4 py-2">Sponsorer</h1>
          <SponsorList size="md" sponsors={regularSponsors} />
        </div>
      </div>
      <div class="space-y-8">
        <h1 class="text-md mx-auto w-fit px-4 py-2">Støttespillere</h1>
        <SponsorList size="sm" sponsors={supporterSponsors} />
      </div>
      <div class="grid gap-24 sm:grid-cols-5 sm:gap-8">
        <div class="space-y-8 sm:col-span-3">
          <h1 class="text-md mx-auto w-fit px-4 py-2">Offentlig støtte</h1>
          <SponsorList size="sm" sponsors={publicSponsors} />
        </div>
        <div class="space-y-8 sm:col-span-2">
          <h1 class="text-md mx-auto w-fit px-4 py-2">Samarbeidspartnere</h1>
          <SponsorList size="sm" sponsors={partners} />
        </div>
      </div>
    </div>
  </div>
</section>
