---
import { Icon } from "astro-icon";
import { Image } from "astro:assets";

import { imagePathToSrc } from "../utils/images";
import HeaderDate from "./HeaderDate.astro";

export interface Props {
  class?: string;
  navItems: {
    title: string;
    href?: string;
    items?: {
      href: string;
      title: string;
    }[];
  }[];
}

const { class: extraClasses, navItems } = Astro.props;

const isActive = (href) =>
  Astro.url.pathname === href || Astro.url.pathname === `${href}/`;
---

<div class={`relative ${extraClasses}`}>
  <nav
    class="menu fixed left-0 top-0 flex w-full gap-10 rounded-b-lg bg-dark-blue px-6 py-4 text-white shadow-xl"
  >
    <a href="/" class="ml-2 shrink-0 transition-transform hover:-rotate-6"
      ><Image
        src={imagePathToSrc("/src/images/profil/logo/tertiary/white.svg")}
        class="jazzlaug h-auto w-12 transition-all duration-700"
        alt="Mandaljazz logo"
        loading="eager"
      /></a
    >

    <div class="flex w-full flex-row items-center gap-4 sm:gap-8">
      {
        navItems.map(({ href, title, items }) => {
          if (items?.length) {
            const isMenuActive = items.some((item) => isActive(item.href));

            return (
              <div class="relative whitespace-nowrap">
                {isMenuActive ? (
                  <div class="absolute -right-1 top-0.5 h-6 w-6 rounded-full bg-blue" />
                ) : null}
                <div class="group relative">
                  <button
                    type="button"
                    class="relative z-10 flex cursor-pointer items-center gap-2"
                    aria-haspopup="true"
                  >
                    <span>{title}</span>
                    <Icon
                      class="transition-transform group-focus-within:rotate-180 group-hover:rotate-180"
                      pack="ion"
                      name="chevron-down"
                      size={16}
                    />
                  </button>
                  <div class="pointer-events-none absolute -left-4 top-full min-w-max pt-3 opacity-0 transition-opacity group-focus-within:pointer-events-auto group-focus-within:opacity-100 group-hover:pointer-events-auto group-hover:opacity-100">
                    <div class="flex flex-col gap-6 rounded-lg bg-dark-blue px-8 pb-8 pt-4 shadow-lg">
                      {items.map((item) => (
                        <div class="relative w-fit whitespace-nowrap transition-transform hover:-rotate-3">
                          {isActive(item.href) ? (
                            <div class="absolute -left-3 -top-1 h-9 w-9 rounded-full bg-blue" />
                          ) : null}
                          <a
                            href={item.href}
                            title={item.title}
                            class="relative z-10"
                          >
                            {item.title}
                          </a>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (!href) {
            return null;
          }

          return (
            <div class="relative whitespace-nowrap transition-transform hover:-rotate-3">
              {isActive(href) ? (
                <div class="absolute -left-3 -top-1 h-9 w-9 rounded-full bg-blue" />
              ) : null}
              <a href={href} title={title} class={`relative z-10`}>
                {title}
              </a>
            </div>
          );
        })
      }
    </div>

    <HeaderDate id="desktop-header-date" />
  </nav>
</div>

<script>
  let lastKnownScrollPosition = 0;
  let ticking = false;

  function setMenuHeight(scrollPos) {
    const menu = document.querySelector(".menu .jazzlaug");
    const headerDate = document.getElementById("desktop-header-date");

    if (scrollPos > 100) {
      menu.classList.add("w-6");
      menu.classList.remove("w-12");
      if (headerDate) {
        headerDate.classList.add("opacity-100", "translate-y-0");
        headerDate.classList.remove("opacity-0", "translate-y-1/3");
      }
    } else {
      menu.classList.add("w-12");
      menu.classList.remove("w-6");
      if (headerDate) {
        headerDate.classList.add("opacity-0", "translate-y-1/3");
        headerDate.classList.remove("opacity-100", "translate-y-0");
      }
    }
  }

  document.addEventListener("scroll", (event) => {
    lastKnownScrollPosition = window.scrollY;

    if (!ticking) {
      window.requestAnimationFrame(() => {
        setMenuHeight(lastKnownScrollPosition);
        ticking = false;
      });

      ticking = true;
    }
  });
</script>
